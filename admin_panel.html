<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>CPAdmin</title>
  <!--
    Note: Not suitable for production. This app slowly compiles JSX with Babel 
    in the browser and uses a large development build of React.
  -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">

    const FetchStatus = ({ isFetching }) => (
      <div>
        {isFetching
          ? "Fetching..."
          : null
        }
      </div>  
    )

    const UserAgent = ({ globalTopic, setGlobalTopic, isFetching, setIsFetching, data }) => {
      const [response, setResponse] = React.useState("")
      const localTopic = "USER_AGENT"
      const handleClick = (e) => {
        e.preventDefault()
        setGlobalTopic(localTopic)
        setIsFetching(true)
      }
      React.useEffect(() => {
        if (globalTopic === localTopic) {
          setResponse (data.message)
        }
      }, [data])
      return (
        <div>
          <a href="#" onClick={handleClick}
          >Get User Agent Info</a>
          <FetchStatus isFetching={isFetching}/>
          <div>Response: {response}</div>
          <br />
        </div>  
      )
    }

    const FooBar = ({ globalTopic, setGlobalTopic, isFetching, setIsFetching, data }) => {
      const [response, setResponse] = React.useState("")
      const localTopic = "FOO_BAR"
      const handleClick = (e) => {
        e.preventDefault()
        setGlobalTopic(localTopic)
        setIsFetching(true)
      }
      React.useEffect(() => {
        if (globalTopic === localTopic) {
          setResponse (data.message)
        }
      }, [data])
      return (
        <div>
          <a href="#" onClick={handleClick}
          >Do Foo Bar Thing</a>
          <FetchStatus isFetching={isFetching}/>
          <div>Response: {response}</div>
          <br />
        </div>  
      )
    }

    const App = () => {
      const [globalTopic, setGlobalTopic] = React.useState("")
      const [isFetching, setIsFetching] = React.useState(false)
      const [data, setData] = React.useState({})

      React.useEffect(() => {
        if (!isFetching) {
          return
        }
        const goFetch = async () => {
          let responseBody = {}
          try {
            const responseStream = await fetch(`http://localhost:8000`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ topic: globalTopic })
            })
            responseBody = await responseStream.json()
          } catch (error) {
            console.log("There was a problem fetching or parsing response body (CPKE).")
            console.log(error)
          }
          setData(responseBody)
          setIsFetching(false)
        }
        goFetch()
      }, [isFetching])

      return (
        <div>
          <h4>Cooperative.party Admin Panel</h4>
          <UserAgent globalTopic={globalTopic} setGlobalTopic={setGlobalTopic} isFetching={isFetching} setIsFetching={setIsFetching} data={data}/>
          <FooBar globalTopic={globalTopic} setGlobalTopic={setGlobalTopic} isFetching={isFetching} setIsFetching={setIsFetching} data={data}/>
        </div>
      )
    }

    const domContainer = document.getElementById('root')
    const root = ReactDOM.createRoot(domContainer)
    
    root.render(<App />)

  </script>
</body>

</html>