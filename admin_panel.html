<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>CPAdmin</title>
  <!--
    Note: Not suitable for production. This app slowly compiles JSX with Babel 
    in the browser and uses a large development build of React.
  -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">

    const FetchStatus = ({ isFetching }) => (
      <div>
        {isFetching
          ? "Fetching..."
          : null
        }
      </div>  
    )

    const ClickableAction = ({ linkText, localTopic, globalTopic, setGlobalTopic, isFetching, setIsFetching, data }) => {
      const [response, setResponse] = React.useState("")
      const handleClick = (e) => {
        e.preventDefault()
        setGlobalTopic(localTopic)
        setIsFetching(true)
      }
      React.useEffect(() => {
        if (globalTopic === localTopic) {
          setResponse (data.message)
        }
      }, [data])
      return (
        <div>
          <a href="#" onClick={handleClick}
          >{linkText}</a>
          {globalTopic === localTopic && <FetchStatus isFetching={isFetching}/>}
          <pre>{response}</pre>
          <br />
        </div>  
      )
    }

    const App = () => {
      const [globalTopic, setGlobalTopic] = React.useState("")
      const [isFetching, setIsFetching] = React.useState(false)
      const [data, setData] = React.useState({})

      React.useEffect(() => {
        if (!isFetching) {
          return
        }
        const goFetch = async () => {
          let responseBody = {}
          try {
            const responseStream = await fetch(`http://localhost:8000`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ topic: globalTopic })
            })
            responseBody = await responseStream.json()
          } catch (error) {
            console.log("There was a problem fetching or parsing response body (CPKE).")
            console.log(error)
          }
          setData(responseBody)
          setIsFetching(false)
        }
        goFetch()
      }, [isFetching])

      return (
        <div>
          <h4>Cooperative.party Admin Panel</h4>
          <ClickableAction 
            linkText={"Get User Agent Info"}
            localTopic={"USER_AGENT"}
            globalTopic={globalTopic} 
            setGlobalTopic={setGlobalTopic} 
            isFetching={isFetching} 
            setIsFetching={setIsFetching} 
            data={data}
          />
          <ClickableAction 
            linkText={"Do Foo Thing"}
            localTopic={"FOO_BAR"}
            globalTopic={globalTopic} 
            setGlobalTopic={setGlobalTopic} 
            isFetching={isFetching} 
            setIsFetching={setIsFetching} 
            data={data}
          />
          <ClickableAction 
            linkText={"View Terraform Commands"}
            localTopic={"TERRAFORM_HELP"}
            globalTopic={globalTopic} 
            setGlobalTopic={setGlobalTopic} 
            isFetching={isFetching} 
            setIsFetching={setIsFetching} 
            data={data}
          />
 
        </div>
      )
    }

    const domContainer = document.getElementById('root')
    const root = ReactDOM.createRoot(domContainer)
    
    root.render(<App />)

  </script>
</body>

</html>
